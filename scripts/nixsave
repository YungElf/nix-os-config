#!/bin/bash

set -e

cd /etc/nixos

# Optional commit message from first argument
if [ -n "$1" ]; then
    MSG="$1"
else
    MSG="NixOS rebuild: $(date '+%Y-%m-%d %H:%M:%S')"
fi

# Try rebuild first
echo "ğŸ”§ Running nixos-rebuild switch..."
if sudo nixos-rebuild switch; then
    echo "âœ… Rebuild successful. Committing changes..."
    sudo git add .
    sudo git commit -m "$MSG"
    sudo git push
    echo "ğŸš€ Config committed and pushed to GitHub!"
else
    echo "âŒ Rebuild failed. Nothing committed."
    exit 1
fi

